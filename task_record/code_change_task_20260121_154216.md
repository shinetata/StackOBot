# code_change_task_20260121_154216

## 1. 任务概述
- 目标：优化 UE::Tasks 托管批处理路径，降低调度与跨边界调用开销。
- 动机：追求极致性能，减少每个 index 的 Task 调度与 Runtime_Invoke 次数。
- 影响范围：UE::Tasks internal call 与 C# 批处理封装。

## 2. 聊天与讨论背景
- 用户要求对 UE::Tasks 托管调用进行“整体大改一波”，并由用户自行测试性能。
- 遵循项目约束：优先在 `Plugins/UnrealCSharp/` 与 `Script/` 范围内改动。

## 3. 设计思路
- 引入“分块执行”策略：native 侧按 chunk 分发任务，单任务调用 C# `ExecuteTaskRange`，由 C# 内循环执行区间。
- 支持可选 `chunkSize`，默认自动根据 worker 数估算并控制任务数量。
- 保留原 `ExecuteTask` 作为 fallback，避免旧路径完全失效。

## 4. 关键改动说明
- C++：新增 `ExecuteBatchChunked` internal call；按 chunk 生成任务并优先调用 `ExecuteTaskRange`。
- C#：新增 `ExecuteTaskRange`；`ExecuteBatch` 增加 `chunkSize` 参数并转到 chunked internal call。
- 兼容性：旧 `ExecuteBatch/ExecuteTask` 仍可用，作为 fallback 路径。

## 5. 关键代码解析
- `ResolveChunkSize` 依据任务数与 worker 数估算 chunk；`TaskCount = ceil(taskCount / chunkSize)`。
- 每个 UE::Tasks 任务只进行一次托管调用（`ExecuteTaskRange`），在 C# 内循环执行 index 区间。
- 当 `ExecuteTaskRange` 不存在时，fallback 为逐 index 调用 `ExecuteTask`。

## 6. 涉及文件清单
- `Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FTasks.cpp`
  - 增加 chunked 执行与 `ExecuteTaskRange` 优先路径。
- `Plugins/UnrealCSharp/Script/UE/Library/FTasksImplementation.cs`
  - 新增 chunked internal call 声明。
- `Plugins/UnrealCSharp/Script/UE/Library/UETasksBatch.cs`
  - 新增 `ExecuteTaskRange`，`ExecuteBatch` 支持 `chunkSize`。

## 7. 验证方式与结果
- 未执行（需用户在 Editor/运行环境中自行性能测试）。
- 建议对比执行同一 workload 的吞吐量与总耗时。
