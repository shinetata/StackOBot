# 代码生成任务记录

## 1. 任务概述
- 目标：修复调试模式下 TaskGraph worker 托管执行的崩溃（debugger-agent TLS 断言）。
- 动机：用户反馈快速 Stop 导致 UE Editor 闪退。
- 影响范围：`FMonoDomain` 的 detach 判定与方案文档更新。

## 2. 聊天与讨论背景
- 用户提供崩溃堆栈，指向 `FTaskGraph` worker 执行托管逻辑时崩溃。
- 现象在开启 `IsEnableDebug` 时复现，关闭后不再闪退。

## 3. 设计思路
- 调试模式下禁用 per-job detach，避免 debugger-agent 线程 TLS 重复初始化断言。
- 非调试模式保持 Editor 下 detach，以规避跨 PIE 残留。

## 4. 关键改动说明
- `FMonoDomain`：缓存 `IsEnableDebug()` 状态，`ShouldDetachAfterManagedJob()` 在调试模式下返回 false。
- 文档更新：补充调试模式 detach 策略说明。

## 5. 关键代码解析
- `FMonoDomain::Initialize()`：读取 `UUnrealCSharpSetting::IsEnableDebug()` 并缓存。
- `FMonoDomain::ShouldDetachAfterManagedJob()`：Editor 下根据缓存决定是否 detach。

## 6. 涉及文件清单
- `Plugins/UnrealCSharp/Source/UnrealCSharpCore/Public/Domain/FMonoDomain.h`
  - 增加调试状态缓存字段。
- `Plugins/UnrealCSharp/Source/UnrealCSharpCore/Private/Domain/FMonoDomain.cpp`
  - 缓存调试状态并调整 detach 策略。
- `docs/tech/unrealcsharp/unrealcsharp-taskgraph-worker-scripting-jobs-fence.md`
  - 补充调试模式禁用 per-job detach 的说明。
- `docs/tech/index.md`
  - 索引“最后修改日志”更新。

## 7. 验证方式与结果
- 用户反馈：关闭 `IsEnableDebug` 后不再闪退。
- 建议验证：开启 `IsEnableDebug` 后重复 Play/Stop，确认不再触发 debugger-agent TLS 断言。
