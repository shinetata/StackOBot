# 代码变更任务记录：恢复 TaskGraph 最小 PoC（worker 调度并执行 C#）

## 任务概述
- 目标：重新实现 TaskGraph 最小验证逻辑，证明“Native 子线程（UE TaskGraph worker）可以 attach Mono 并执行 C# 方法”。
- 范围：仅新增 PoC 所需的 C++ internal call 与 C# probe，并在技术文档中补回验证步骤。

## 关键思路
- C# 调用 internal call：`FTaskGraph_EnqueueProbeImplementation(token)`
- C++ 侧投递 `FFunctionGraphTask` 到 `ENamedThreads::AnyBackgroundThreadNormalTask`
- 在 TaskGraph worker 线程内：
  - `mono_thread_attach(FMonoDomain::Domain)`
  - `FMonoDomain::Runtime_Invoke(...)` 调用托管静态方法 `Script.Library.TaskGraphProbe.OnWorker(...)`
  - `OnWorker` 里 `Console.WriteLine` 打点并输出 GT/Worker 的 native thread id

## 涉及文件清单
- 新增：`Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FTaskGraph.cpp`
- 新增：`Plugins/UnrealCSharp/Script/UE/Library/TaskGraphProbe.cs`
- 修改：`docs/tech/unrealcsharp-taskgraph-parallel-csharp.md`
- 新增：`task_record/code_change_task_20260113_100943.md`
- 修改：`task_record/index.md`

## 验证方式（手动）
1) 在任意会在运行时执行的 C# 入口调用 `Script.Library.TaskGraphProbe.Enqueue(123);`
2) 在 Output Log 搜索 `[TaskGraphProbe] token=123 ... GT=... Worker=...`
3) 确认 `GT` 与 `Worker` 的 native thread id 不相同

## 风险与注意事项
- `OnWorker` 运行在 TaskGraph worker 上：不得触碰 `UObject`/`ProcessEvent`/任何 UE API。
- 当前实现采用“每次任务都调用 `mono_thread_attach`”（通常幂等）；正式方案可优化为“每线程一次 attach（TLS 标记）”。

## 回滚方式
- 删除新增文件并回退文档/索引：
  - `git rm Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FTaskGraph.cpp`
  - `git rm Plugins/UnrealCSharp/Script/UE/Library/TaskGraphProbe.cs`
  - `git checkout -- docs/tech/unrealcsharp-taskgraph-parallel-csharp.md`
  - 从 `task_record/index.md` 移除对应索引行

