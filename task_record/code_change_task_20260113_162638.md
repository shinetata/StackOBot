# 任务记录：补充 TaskGraph 非阻塞式批次执行方案（文档）

## 任务概述
- **目标**：在已有 TaskGraph 讨论文档中补齐“非阻塞式（dispatch 立即返回）”的可落地方案，用于后续实现 `ScheduleParallel`/异步批次执行。
- **动机**：当前 `TaskGraphBatch.ExecuteBatch(...)` 固定阻塞等待（`wait=true`），无法满足游戏线程不阻塞的需求；直接把 `wait` 改为 `false` 会导致 `GCHandle` 提前释放引发回调失效。

## 关键结论（方案要点）
- 非阻塞不能只改 `wait=false`：必须把 `GCHandle` 生命周期延续到“所有 worker 任务完成后”，并由 completion 回调负责释放。
- 最小实现建议利用 TaskGraph 的 prerequisites：
  - dispatch `N` 个 worker task；
  - 再 dispatch 一个 completion task，依赖 `N` 个 task 的 `GraphEvent`，完成后触发一次托管 `Complete(handle)`。
- 异常建议在托管侧 `try/catch` 记录并聚合，避免异常穿透到 native 触发 `Unhandled_Exception`。
- “回到 GT”作为可选策略：要么依赖 `await` 在 GT 捕获同步上下文回 GT；要么直接让 completion task 在 `ENamedThreads::GameThread` 执行（只做 signal，不做重活）。

## 涉及文件清单
- `docs/tech/unrealcsharp-taskgraph-parallel-csharp.md`
  - 修复了冲突标记残留
  - 更新 thread attach 说明为 `EnsureThreadAttached()`
  - 新增 `4.3 非阻塞式方案（设计草案）`，包含 ASCII 流程图与托管侧伪代码

