# 任务记录：Combine 性能优化（减少分配 + 缩短锁持有）

## 任务概述
- 目标：优化 Handle Combine 的性能开销，仅减少分配与缩短原生合并时的锁持有时间。
- 动机：Combine 为高频路径时，C# 侧 ToArray 与 native 锁内合并成本明显。
- 影响范围：仅影响 Combine 路径的内部分配与锁持有时长，不改变对外语义。

## 聊天与讨论背景
- 用户要求仅优化性能问题（分配次数与锁内合并成本），不调整语义或兜底逻辑。
- 明确不引入 Then，不改变 Schedule/Combine 调用方式。

## 设计思路
- C# Combine：用固定长度数组替代 List + ToArray，减少一次分配与复制。
- Native Combine：锁内只搬出 TaskList，锁外合并，再锁内回写，缩短锁持有时长。

## 关键改动说明
- C# Combine 改为 `long[] ids` + `idCount`，避免 `ids.ToArray()`。
- Native Combine 改为 `StagedLists` 暂存 TaskList，锁外合并任务。

## 关键代码解析
- C# Combine：
  - 收集 handleId 到 `long[] ids`；
  - 调用 `FTasksQuery_CombineHandlesImplementation(ids)`；
  - 成功后创建合并句柄（GCHandle 逻辑保持原样）。
- Native Combine：
  - 锁内：`StagedLists.Add(MoveTemp(*TasksPtr))` + `HandleTasks.Remove(HandleId)`；
  - 锁外：统计总任务数并 `CombinedTasks.Reserve`，逐个 MoveTemp 合并；
  - 锁内：`HandleTasks.Add(NewHandleId, MoveTemp(CombinedTasks))`。

## 涉及文件清单
- `Script/Game/PGD/Parallel/UETasksJobHandleUtils.cs`
  - Combine 使用固定数组，减少一次 ToArray 分配。
- `Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FTasksQuery.cpp`
  - CombineHandles 锁内仅搬出任务列表，锁外合并。

## 验证方式与结果
- 未运行（用户自行编译/运行）。
- 建议：运行现有 MainMenu_C 中的 Combine 性能测试入口。
