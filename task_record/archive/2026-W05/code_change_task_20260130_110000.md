# UETasks 深度审视与优化

## 任务概述
根据 UETasks 优化计划，对 UETasksQueryExtensions.cs 进行重构：
- 提取重复的 Chunk 收集逻辑为 `CollectChunks<T>` 辅助方法
- 删除所有方法中未使用的 `taskCount` 参数
- 优化数组分配策略（使用 List 替代手动 Resize）
- 在 UETasksQueryRunner.cs 中添加 taskIndex/chunkIndex 语义注释

## 涉及文件清单
| 文件路径 | 改动类型 |
|---------|---------|
| `Script/Game/PGD/Parallel/UETasksQueryExtensions.cs` | 重构、删除参数 |
| `Plugins/UnrealCSharp/Script/UE/Library/UETasksQueryRunner.cs` | 添加注释 |

## 关键改动说明

### 1. 提取 CollectChunks<T> 泛型辅助方法
将 4 处重复的 Chunk 收集逻辑（约 80 行代码）提取为单一泛型方法：
```csharp
private static (T[] chunks, int count) CollectChunks<T>(this IQuery query)
{
    var chunkCount = query.ChunkCount;
    var list = new List<T>(chunkCount > 0 ? chunkCount : 0);

    foreach (var chunk in query.ArchetypeChunk)
    {
        list.Add(chunk);
    }

    var chunks = list.ToArray();
    return (chunks, chunks.Length);
}
```

### 2. 删除 taskCount 参数
从以下 4 个方法中删除了未使用的 `int taskCount = 0` 参数：
- `ExecuteUeParallel<T1>`
- `ScheduleUeParallel<T1>`
- `ExecuteUeParallel<T1, T2>`
- `ScheduleUeParallel<T1, T2>`

### 3. 优化数组分配策略
- 使用 `List<T>` 替代手动数组 + Resize
- 精确初始容量：`chunkCount > 0 ? chunkCount : 0`（避免 chunk1 时分配Count=0/ 4 个元素的数组）

### 4. 添加语义注释
在 `IUETasksQueryRunner.ExecuteTask` 接口中添加注释说明 `taskIndex` 实际对应 `chunkIndex`。

## 代码行数变化
- 重构前：~326 行
- 重构后：~227 行
- 减少：~99 行（30%）

## 验证方式
```bash
# 编译 C# 项目
# 运行 MainMenu_C.cs 中的性能测试
```
