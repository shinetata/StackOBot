# PGD UE Tasks - CollectChunks 内存分配优化

## 时间戳
2026-01-31 15:00:00

## 任务概述
优化 `UETasksQueryExtensions.cs` 中的 `CollectChunks` 方法，消除二次内存分配。

## 问题分析

### 原始代码（问题）
```cs
private static (ArchetypeChunk<T1>[] chunks, int count) CollectChunks<T1>(this IQuery<T1> query)
{
    var chunkCount = query.ChunkCount;
    var list = new List<ArchetypeChunk<T1>>(chunkCount > 0 ? chunkCount : 0);

    foreach (var chunk in query.ArchetypeChunk)
    {
        list.Add(chunk);
    }

    var chunks = list.ToArray();  // 第二次分配！
    return (chunks, chunks.Length);
}
```

**问题**：
1. `new List<>()` 分配底层数组
2. `ToArray()` 再分配一个新数组并复制

## 设计思路

利用 `query.ChunkCount` 是可靠的前提，直接分配目标大小的数组。

### 优化后代码
```cs
private static (ArchetypeChunk<T1>[] chunks, int count) CollectChunks<T1>(this IQuery<T1> query)
{
    var chunkCount = query.ChunkCount;
    if (chunkCount <= 0)
    {
        return (Array.Empty<ArchetypeChunk<T1>>(), 0);
    }

    var chunks = new ArchetypeChunk<T1>[chunkCount];
    var index = 0;
    foreach (var chunk in query.ArchetypeChunk)
    {
        chunks[index++] = chunk;
    }
    return (chunks, chunkCount);
}
```

## 关键改动说明

### 兼容性分析
- `CollectChunks` 是 **private static** 方法
- C++ 接口只接收 `GCHandle` 指针和 `TaskCount` 整数
- 优化不影响任何对外接口

### 性能收益
- 减少 50% 堆分配（从 2 次减少到 1 次）
- 消除 `List.ToArray()` 的数组复制操作

## 涉及文件清单

| 文件 | 改动类型 | 改动说明 |
|------|----------|----------|
| `Script/Game/PGD/Parallel/UETasksQueryExtensions.cs` | 修改 | 优化 CollectChunks<T1> 和 CollectChunks<T1,T2> 方法；移除不再使用的 `using System.Collections.Generic;` |

## 验证方式与结果
- [x] 编译通过（需要用户在 UE 编辑器中验证）
- [ ] 运行 `MainMenu_C.cs` 性能测试
- [ ] 对比优化前后执行时间
