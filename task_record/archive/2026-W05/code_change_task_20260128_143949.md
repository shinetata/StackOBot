# 任务记录：基于 UE Tasks 的 IQuery.ParallelForEach 方案设计文档

## 1. 任务概述
- 目标：为“基于 UE Tasks 的 IQuery.ParallelForEach（独立方案）”整理可执行的设计文档，便于后续实现。
- 范围：仅新增设计文档与索引；不改代码与配置。

## 2. 聊天与讨论背景
- 用户已引入 PGD.dll，并希望在当前工程中设计一套“基于 UE Tasks”的并行化方案，使用体验与 `IQuery.ParallelForEach` 基本一致。
- 用户强调：该方案独立于 PGD 内部并行机制，仅参考其使用形式。
- 用户提到：项目内已有 UE Tasks 运行 C# 托管代码的示例，可作为参考。

## 3. 设计思路
- 采用“Query 切片 + UE Tasks 调度 + C# 托管执行”的架构。
- C# 侧负责构建切片（chunk/连续内存段），C++ 侧使用 UE::Tasks 调度并在 worker 线程调用托管 thunk。
- 提供两条执行路径：
  - 高性能路径：static 方法 + unmanaged thunk（不允许闭包）。
  - 易用路径：允许闭包，但走 Runtime_Invoke（性能较低）。

## 4. 关键改动说明
- 新增设计文档，明确 API 形态、切片结构、调度策略、线程/异常处理与验证方案。
- 更新技术文档索引与任务记录索引。

## 5. 关键代码解析
- 本次无代码改动；文档中给出示意性 C# API 与 QuerySlice 结构，仅作为后续实现指引。

## 6. 涉及文件清单
- 新增：`docs/tech/pgd/ue_tasks_parallel_query_design.md`（方案设计文档）
- 修改：`docs/tech/index.md`（新增文档索引）
- 修改：`task_record/index.md`（新增任务索引）
- 新增：`task_record/archive/2026-W05/code_change_task_20260128_143949.md`（本任务记录）

## 7. 验证方式与结果
- 验证方式：无（仅文档与索引变更）。
- 结果：无需运行测试。
