# 代码改动任务记录：重写「PGD × UE TaskGraph Native Kernel」综合文档（方案+测试+结论）

## 1) 任务概述
- 目标：将截至目前为止与“PGD 结合 UE TaskGraph（重点：Native Kernel）”有关的方案设计、测试设计（方案与结果）、问题与结论，整合为一份结构清晰、内容完整的统一文档。
- 动机：原有团队文档 `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md` 信息密度不足，且对“托管代码跑在 TaskGraph worker 上”的风险、NativeBuffer/Kernel/Runner 的关键链路、测试公允性与结果含义解释不够清楚，容易误导后续决策。
- 影响范围：仅文档与索引；不改动任何运行时代码/基准代码。

## 2) 聊天与讨论背景（要点）
- 用户要求：在不引入 PGD 的前提下，在 StackOBot 内模拟 PGD 类 ECS workload 并完成对比测试；随后把方案与过程整理成文档，重点解释 TaskGraph 的性能收益点与适用边界。
- 用户强调：必须避免“逻辑差异导致的虚假性能”，结论必须以当前测试代码与日志为准。
- 本次具体需求：基于 `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md` 优化一版，补齐：
  1) 两种用 TaskGraph 运行 C# 托管代码的方式与问题；
  2) Native Kernel 的设计与测试结果（附关键代码示例与 NativeBuffer 设计思路）；
  3) 若采用 Native Kernel，PGD 需要改动哪些模块（概括）。

## 3) 设计思路（写作与内容组织）
- 以仓库“现有代码实现与日志字段”为唯一事实来源：所有路径、API、参数含义、输出格式均对应到真实文件路径。
- 文档结构先回答“能怎么做 + 会遇到什么问题”，再讲“Native Kernel 怎么做 + 怎么测 + 测到了什么”，最后给“PGD 要改哪些模块”的概括。
- 测试结果表格以 `docs/tech/taskgraph/taskgraph-performance-verification-summary.md` 为汇总来源，并同步到综合文档，减少跨文档跳转成本。

## 4) 关键改动说明
- 重写 `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md` 为单文件可读的综合文档：
  - 明确适用范围：纯 ECS 数据遍历写回（不碰 UObject）；
  - 对比两条路线：worker 进 Mono（`EnsureThreadAttached + Runtime_Invoke`）vs worker 不进 Mono（native kernel）；
  - 解释 `NativeBuffer<T>` 的定位、初始化方式与 `Span<T>` 生命周期约束；
  - 解释“TaskGraph 在这里到底起了什么作用”，与“普通 C++ 并行”的差异；
  - 将单数组 / 多 archetype 固定参数 / sweep 三类验证方案统一在同一章节，表格化呈现，并补齐结论与边界条件。
- 更新 `docs/tech/index.md`：回填该文档条目的“最后修改日志”链接到本任务记录，符合文档管理规范。
- 补充关键代码片段：在综合文档中补齐 worker 进入 Mono 的 C++ 调用链节选、C# 对照组的 chunk 核心循环节选，以及 Runner 的交错顺序/median/sumOk 节选，避免读者把结论误归因于 `Span<T>` 边界检查或“口头约定”。

## 5) 关键代码链路解析（用于文档解释，未改代码）

### 5.1 方式 A：worker 跑托管代码（风险来源）
- internal call：`Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FTaskGraph.cpp`
- 关键点：TaskGraph worker task 内调用 `FMonoDomain::EnsureThreadAttached()`，并通过 `FMonoDomain::Runtime_Invoke(...)` 执行 C# 方法。

### 5.2 方式 B：Native Kernel（本文主线）
- 数据：`Plugins/UnrealCSharp/Script/UE/Library/NativeBuffer.cs`
- 单数组 kernel：`Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FNativeBufferTaskGraph.cpp`
- ECS kernel：`Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FNativeBufferTaskGraphEcs.cpp`
- 对照组（C# 并行）：`Plugins/UnrealCSharp/Script/UE/Library/CSharpParallelPerf.cs`
- Runner（交错顺序 + median + sumOk）：
  - `Plugins/UnrealCSharp/Script/UE/Library/TaskGraphVsCSharpPerfRunner.cs`
  - `Plugins/UnrealCSharp/Script/UE/Library/TaskGraphVsCSharpEcsPerfRunner.cs`

## 6) 涉及文件清单
- `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md`：重写综合文档。
- `docs/tech/index.md`：更新该文档条目的“最后修改日志”。
- `task_record/archive/2026-W04/code_change_task_20260119_164500.md`：本任务记录（归档）。
- `task_record/index.md`：更新本记录链接路径（指向归档文件）。

## 7) 验证方式与结果
- 目视检查：
  - `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md` 章节结构完整、路径引用可点击、包含关键代码片段与结果表格；
  - `docs/tech/index.md` 对应条目能定位到该文档，并包含“最后修改日志”；
  - `task_record/index.md` 对应索引链接可定位到归档记录文件。
- 未做运行时验证：本任务仅重写文档，不修改基准代码与输出逻辑。
