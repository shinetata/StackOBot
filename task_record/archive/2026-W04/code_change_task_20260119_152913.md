# 代码改动任务记录：PGD 对标 Unity ECS managed/unmanaged 双存储改动清单与方案

## 1) 任务概述
- 目标：整理“PGD 若对标 Unity ECS（DOTS Entities）并支持 managed/unmanaged 双存储（unmanaged 走 native kernel）”所需的改动点与可选方案，给出可分阶段落地路线。
- 影响范围：仅新增文档，不改代码。

## 2) 聊天与讨论背景
- 背景：前序讨论聚焦“PGD 替换 PGDArray 为 NativeBuffer 以接入 UE TaskGraph/native kernel”时发现硬约束：只有 unmanaged 组件能安全指针化；因此会出现“native/managed 两套底层存储并存”的设计问题。
- 关键问题：
  - Unity ECS 是否也存在两套存储结构？如何解决冲突并支持两类数据？
  - PGD 若对标 Unity ECS，需要改哪些地方、有哪些方案、各自代价是什么？

## 3) 设计思路
- 交叉验证依据：
  - Unity Entities 1.3.2 随包文档（`Documentation~/components-managed.md`）对 managed component 的限制与存储方式说明。
  - Unity.Entities 源码中 `ManagedComponentStore`/chunk 复制逻辑/managed accessor 的实现，验证“chunk 存索引、world 存 object[]”。
- 方案表达方式：
  - 先给出“对标等级 L0/L1/L2”（从最小可用到深度对标）以便裁剪范围。
  - 再按模块列出改动点：类型系统、存储、Query/代码生成、调度、生命周期规则、拷贝/销毁语义等，并给出可选方案与风险。

## 4) 关键改动说明
- 新增文档 `docs/tech/pgd/pgd-align-unity-ecs-managed-unmanaged-storage.md`：
  - 说明 Unity ECS managed/unmanaged 双存储的机制与冲突解决策略（文档 + 源码双证据）。
  - 对齐 PGD 当前实现基线（PgdArray<T> 为 T[]、Query 生成的 ArchetypeChunk 切片、ParallelForEach 调度模型）。
  - 分模块罗列“必须改/可选改”的改动点与方案，并给出阶段化落地路线（P0~P3）。

## 5) 关键内容解析（节选）
- 核心判断：双存储并存不是问题本身，关键在于“类型/调度/生命周期硬隔离”，并避免在热点循环做路径分支。
- 推荐路线：先做 L0（unmanaged 才能走 native kernel），再视需求决定是否引入 Unity 式 ManagedComponentStore（L1）。

## 6) 涉及文件清单
- 新增：`docs/tech/pgd/pgd-align-unity-ecs-managed-unmanaged-storage.md`：双存储对标改动点与方案清单。
- 新增：`task_record/archive/2026-W04/code_change_task_20260119_152913.md`：本任务记录。
- 修改：`task_record/index.md`：追加索引行。

## 7) 验证方式与结果
- 验证方式：目视检查 Markdown 结构、术语一致性、对标等级与改动点清单完整性；检查引用路径是否存在于给定版本的 `com.unity.entities@1.3.2` 包结构中。
- 结果：通过。
