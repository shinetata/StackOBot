# 代码改动任务记录：补齐 Unity ECS 双存储说明，并细化 PGD Native Kernel 改动模块清单

## 1) 任务概述
- 目标：在 `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md` 的“PGD 需要改动哪些模块”章节中，先详细解释 Unity ECS（DOTS Entities）如何处理 unmanaged/managed 双存储结构，再基于该机制推导出 PGD 为支持 Native Kernel 路线需要改动的模块清单。
- 动机：此前“PGD 需要改动哪些模块”的结论依赖 Unity ECS 的参考，但文档中缺少对 Unity ECS 双存储机制的完整介绍，导致读者难以判断推导是否成立，也难以评估改动规模。
- 影响范围：仅文档与索引；不改动任何运行时代码/基准代码。

## 2) 聊天与讨论背景（要点）
- 用户要求：PGD 若采用 Native Kernel 路线，需要明确改动模块；但在列模块前必须先讲清楚 Unity ECS 的双存储（unmanaged 与 managed）如何设计与如何避免冲突。
- 要求风格：模块罗列需要“详细”，但每项“改动什么”只需一句话带过。

## 3) 设计思路（交叉验证来源）
- 随包文档（公开材料）：`C:\WorkSpace\GitHub\PGDCS\Test\Entities101\Library\PackageCache\com.unity.entities@1.3.2\Documentation~\components-managed.md`
  - 用于确认“managed component 不存 chunk、chunk 存索引、不能用于 jobs/Burst”等关键约束。
- 源码实现（机制验证）：
  - `...\Unity.Entities\ManagedComponentStore.cs`：确认 World 级对象存储（`m_ManagedComponentData`）。
  - `...\Unity.Entities\Iterators\ArchetypeChunkArray.cs`：确认 chunk 侧通过 `NativeArray<int>`（索引数组）+ store 访问器访问 managed 组件，并注明底层数组可能 reallocate 不可缓存。

## 4) 关键改动说明
- 重写 `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md` 的第 6 节：
  - 新增 “Unity ECS 双存储处理方式（交叉验证）”小节：从 `components-managed.md` 的明示约束出发，再用 `ManagedComponentStore` 与 `ManagedComponentAccessor<T>` 源码节选验证其存储/访问机制。
  - 基于 Unity 的“数据层并存、执行层硬隔离”的原则，细化出 PGD 需要改动的模块清单，并按：类型系统/存储层/view&生成代码/调度后端/结构变更/验证防呆 分组。

## 5) 涉及文件清单
- `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md`：补齐 Unity ECS 双存储说明，并将 PGD 改动模块清单细化为可评估的分组列表。
- `docs/tech/index.md`：更新该文档条目的“最后修改日志”链接到本任务记录。
- `task_record/index.md`：新增一条索引，指向本任务记录。

## 6) 验证方式与结果
- 目视检查：
  - `docs/tech/pgd/pgd-taskgraph-native-kernel-solution.md` 第 6 节包含 Unity ECS 双存储说明（文档路径+关键代码片段）与 PGD 改动模块分组清单。
  - `docs/tech/index.md` 对应条目包含本任务记录链接。
  - `task_record/index.md` 索引行链接可定位到本文件。

