# 任务记录：借鉴 Unity“scripting jobs”经验，梳理 UnrealCSharp × TaskGraph worker 跑 C# 导致 PIE 卡死的可落地解法

## 1) 任务概述

- 目标：基于 `docs/tech/unity_jobsystem/unity_jobsystem_mono_manage.md` 的团队洞察，对照 UnrealCSharp 当前实现，产出“TaskGraph worker 执行 C# 时 PIE 卡死”的可落地解决思路与验证清单。
- 边界：忽略/暂不讨论 Native Kernel 方案；优先沉淀文档，不直接改插件代码。
- 影响范围：仅文档与索引更新（不改 UE/插件运行逻辑）。

## 2) 聊天与讨论背景（要点）

- 用户诉求：当前工程遇到“TaskGraph worker 线程执行 C# 逻辑时 UE Editor PIE 卡死”，希望借鉴 Unity JobSystem 的经验挖掘更好的解法。
- 关键约束：遵循仓库 `AGENTS.md` 工作规范；优先 `Plugins/UnrealCSharp/` 与 `Script/`，但本次先做方案沉淀到 `docs/tech/`。
- 既有资产：仓库内已存在强相关复盘 `docs/tech/unrealcsharp/unrealcsharp-taskgraph-worker-mono-attach-pie-freeze.md`（指出二次 PIE 卡死与 `mono_thread_attach` 强相关，卡死常停在 `LoadFromStream(Game.dll)` 的 `Runtime_Invoke(...)`）。

## 3) 设计思路（核心方案与取舍）

对齐 Unity 的 3 个关键点：

1. Managed Job 由 native 调度 + managed 入口执行（而非“把 IL 搬到 C++”）。
2. worker 是线程池常驻/复用：线程生命周期与 managed 域/程序集重载生命周期天然不对齐。
3. Domain Reload 必须引入全局 barrier：停止新的 scripting jobs → flush/complete 已提交 → 确保不会再回调旧域（必要时 thread detach/域切换）。

在 UE/UnrealCSharp 侧，把它落到可执行的解决路线：

- 路线 0：先把 attach/LoadFromStream/PIE 边界做成“可观测”（日志点位），确认卡死机制。
- 路线 1：Editor 优先的短平快方案——worker 执行 managed 后主动 detach，避免跨 PIE 残留“已登记托管线程”。
- 路线 2：工程化方案——引入 scripting jobs fence（全局开关 + in-flight 计数 + 边界等待/可选批量 detach）。
- 路线 3：约束法——worker 上只做纯计算，任何 UObject/UE API 访问拆回 GameThread（避免 wait:true + 回主线程造成死锁）。

## 4) 关键改动说明（行为/接口变化、风险与回滚）

本次仅新增文档与索引条目：

- 无运行时代码变化、无接口变化、无风险。
- 回滚方式：删除新增文档，并从 `docs/tech/index.md` 移除对应索引行。

## 5) 关键逻辑链路（少量伪代码/链路说明）

UnrealCSharp 当前“worker 跑 managed”的关键链路：

- `Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FTaskGraph.cpp`
  - worker lambda：`EnsureThreadAttached()` → `Runtime_Invoke(ExecuteTask, ...)`
- `Plugins/UnrealCSharp/Source/UnrealCSharpCore/Private/Domain/FMonoDomain.cpp`
  - Editor 下：`AssemblyLoadContext.LoadFromStream(...)` 加载 `Game.dll`

既有复盘指出：只要 worker 做过 attach，二次 PIE 即可能卡在 `LoadFromStream(Game.dll)` 的 invoke 同步点，符合 Unity “reload 需要线程状态收敛/全局 barrier” 的经验模式。

## 6) 涉及文件清单

- 新增 `docs/tech/unrealcsharp/unrealcsharp-taskgraph-worker-scripting-jobs-fence.md`：把 Unity 的“scripting jobs + 全局 barrier”经验映射到 UE/UnrealCSharp 的可落地方案与验证清单。
- 修改 `docs/tech/index.md`：新增上述文档的索引行。

## 7) 验证方式与结果

- 目视检查文档结构与可读性：打开 `docs/tech/unrealcsharp/unrealcsharp-taskgraph-worker-scripting-jobs-fence.md`。
- 校验索引已更新：
  - 运行：`rg "unrealcsharp-taskgraph-worker-scripting-jobs-fence.md" docs/tech/index.md`
- 已知限制：本次未在本机复现 PIE 卡死（缺少用户具体复现步骤/日志/调用栈），因此未直接提交代码修复；文档末尾列出了需要用户补充的信息以收敛到可执行 patch。

