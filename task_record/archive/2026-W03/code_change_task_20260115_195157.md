# 代码变更任务记录：新增 TaskGraph worker 线程分配测试入口（2026-01-15 19:51:57）

## 1) 任务概述

- 目标：检查是否已有“观测 C# 任务被分配到哪些 TaskGraph worker 线程”的测试入口；如不足，补充一个可直接调用的测试方法。
- 动机：验证当前 TaskGraph 执行路径是否会把不同分片任务分配到多个 worker OS 线程，为后续并行化设计与排障提供可观测数据。
- 影响范围：仅新增一个 C# 侧测试工具类，不修改既有实现逻辑。

## 2) 聊天与讨论背景（摘要）

- 用户希望确认：当前 TaskGraph 是否仍保留“把不同 C# 任务分配到不同 worker 线程”的观测方法。
- 现状：已有 `TaskGraphBatch`（批量分片执行）与 `GetCurrentThreadId`（返回 native 线程 ID）的基础能力，但缺少一个一键统计/打印“线程分配分布”的入口。

## 3) 设计思路

- 基于现有机制实现，不引入新的 internal call：
  - C# 分片执行依旧走 `TaskGraphBatch.ExecuteBatch(...)`。
  - 在每个分片回调内调用 `TaskGraphBatch.GetCurrentNativeThreadId()` 获取当前执行该分片的 worker native 线程 ID。
- 统计口径：
  - 记录每个 nativeTid 被执行了多少个分片（计数分布）。
  - 同时记录 `ManagedThreadId` 的分布用于对照（不作为 OS 线程判断的唯一依据）。
- 为了让调度更容易体现“多线程分配”，提供 `workIterationsPerTask` 参数增加每个分片的计算量，避免任务过短导致集中在单线程执行的假象。

## 4) 关键改动说明

- 新增 `TaskGraphWorkerDistribution.Run(...)`：
  - 统计并输出：`uniqueNativeThreads`、每个 `nativeTid` 的任务数量分布，可选逐任务打印。
- 风险与回滚：
  - 仅新增工具类，无运行时副作用；如不需要可直接删除新增文件并移除索引。

## 5) 关键逻辑解析（伪代码）

```
Run(taskCount):
  dict nativeTid -> count
  ExecuteBatch(i):
    tid = GetCurrentNativeThreadId()
    dict[tid]++
  print summary
```

## 6) 涉及文件清单

- 新增：`Plugins/UnrealCSharp/Script/UE/Library/TaskGraphWorkerDistribution.cs`
  - 提供 `Run(...)`，打印 TaskGraph worker 线程分配统计。

## 7) 验证方式与结果

- 验证方式：
  - 在任意可调用 C# 生命周期中执行 `TaskGraphWorkerDistribution.Run(taskCount: 128, workIterationsPerTask: 10000, iterations: 1)`；
  - 观察 Output Log 中 `[TaskGraphWorkerDistribution]` 输出是否包含多个 `nativeTid`。
- 结果：本次变更未在本记录中执行运行验证（需要在 UE Editor 中触发 C# 调用路径）。

