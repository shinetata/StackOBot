# 代码变更任务记录：避免 TaskGraph worker 重复 mono_thread_attach 导致崩溃

## 任务概述
- 目标：修复运行时在 TaskGraph worker 执行 C# 遍历逻辑时 UnrealEditor 闪退的问题（Crash Reporter 指向 `FMonoLog.cpp`，并出现 cooperative GC 线程状态断言）。
- 范围：仅调整 `FMonoDomain::EnsureThreadAttached()` 的实现策略，避免在同一 native worker 线程上重复 attach。

## 问题现象
- UE Editor 闪退并弹出 Crash Reporter。
- Reporter 摘要中出现类似：
  - `mono_coop_mutex_lock Cannot transition thread ... from STATE_BLOCKING ...`
  - Callstack 指向 `Plugins/UnrealCSharp/Source/UnrealCSharpCore/Private/Log/FMonoLog.cpp`

## 根因分析
- TaskGraph worker 线程会复用。
- 我们在 PoC 中每次任务都调用 `mono_thread_attach`（通过 `EnsureThreadAttached`）。
- 在 Mono cooperative GC 模式下，对已附着线程重复 attach 可能触发线程状态断言（尤其在 worker 线程处于 blocking 状态时）。

## 关键改动
- `Plugins/UnrealCSharp/Source/UnrealCSharpCore/Private/Domain/FMonoDomain.cpp`
  - `EnsureThreadAttached()` 改为：
    - 若 `mono_thread_current() != nullptr`（当前线程已附着）则直接返回
    - 仅在未附着时调用 `mono_thread_attach(Domain)`

## 涉及文件清单
- 修改：`Plugins/UnrealCSharp/Source/UnrealCSharpCore/Private/Domain/FMonoDomain.cpp`
- 新增：`task_record/code_change_task_20260113_111604.md`
- 修改：`task_record/index.md`

## 验证方式（建议）
1) 重新编译 `StackOBotEditor`（确保插件 C++ 更新生效）。
2) PIE 后执行：
   - `TaskGraphProbe.MainThreadCreateSharedInt32(10000);`
   - `TaskGraphProbe.Enqueue(123);`
3) 观察：
   - Output Log 出现 `SharedInt32 processed` 日志
   - UE Editor 不再闪退

## 回滚方式
- 回退 `EnsureThreadAttached()` 的变更（不推荐），或暂停 worker 线程执行托管逻辑的 PoC。

