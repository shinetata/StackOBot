# 代码生成任务记录

## 1. 任务概述
- 目标：稳定 TaskGraph worker 执行 C# 逻辑的 PIE 生命周期，避免二次 PIE 卡死。
- 动机：对齐 Unity JobSystem 的“全局屏障 + 线程身份收敛”经验。
- 影响范围：`FMonoDomain` 生命周期、`FTaskGraph` worker 入口与文档更新。

## 2. 聊天与讨论背景
- 用户要求参考 Unity JobSystem 结论与既有文档，形成完整解决方案并落地代码。
- 约束：不讨论 Native Kernel；优先在 `Plugins/UnrealCSharp/` 内改动；输出可调试、可回滚方案。

## 3. 设计思路
- 建立“托管任务闸门 + in-flight 计数 + Drain 等待”作为全局屏障。
- worker 线程执行托管逻辑时统一走 RAII 护栏，Editor 下执行后主动 detach。
- 继续保留“纯计算、结果回主线程应用”的约束，避免 GameThread 互锁。

## 4. 关键改动说明
- `FMonoDomain`：新增 managed job fence 相关 API，并在 Initialize/Deinitialize 中启停与等待归零。
- `FTaskGraph`：worker lambda 使用统一 `FManagedJobScope`，确保 enter/leave 计数与必要的 attach/detach。
- 文档：更新 TaskGraph worker 托管执行完整方案与索引。

## 5. 关键代码解析
- `FManagedJobScope`：
  - `TryEnterManagedJobExecution()` 成功后才允许进入托管区。
  - 进入时 `EnsureThreadAttached()`，退出时（Editor）`EnsureThreadDetached()` 并 `LeaveManagedJobExecution()`。
- `FMonoDomain::Deinitialize()`：
  - `DisableManagedJobExecution()` + `WaitForManagedJobDrain()`，确保 Stop/Unload 前所有托管任务已收敛。

## 6. 涉及文件清单
- `Plugins/UnrealCSharp/Source/UnrealCSharpCore/Public/Domain/FMonoDomain.h`
  - 新增 managed job fence API 与状态字段。
- `Plugins/UnrealCSharp/Source/UnrealCSharpCore/Private/Domain/FMonoDomain.cpp`
  - 实现 fence、attach/detach 与 Deinitialize 期间的屏障等待。
- `Plugins/UnrealCSharp/Source/UnrealCSharp/Private/Domain/InternalCall/FTaskGraph.cpp`
  - worker 入口统一使用 `FManagedJobScope`，屏蔽卸载期托管执行。
- `docs/tech/unrealcsharp/unrealcsharp-taskgraph-worker-scripting-jobs-fence.md`
  - 完整解决方案文档更新。
- `docs/tech/index.md`
  - 索引“最后修改日志”更新。

## 7. 验证方式与结果
- 未执行自动化验证（需要 Editor 交互环境）。
- 建议验证：
  1) PIE 中运行 `TaskGraphBatch.ExecuteBatch(...)` 或 `TaskGraphProbe.Enqueue(...)`。
  2) Stop PIE 后再次 Play，确认不再卡死在 `LoadFromStream(Game.dll)`。
